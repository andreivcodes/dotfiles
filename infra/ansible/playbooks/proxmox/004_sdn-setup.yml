---
- name: Proxmox SDN Configuration
  hosts: proxmox
  gather_facts: true
  become: true
  vars_files:
    - ../../group_vars/all/main.yml
  
  tags:
    - sdn
    - network
  
  tasks:
    - name: Install SDN dependencies
      apt:
        name:
          - frr-pythontools
          - dnsmasq
          - iptables-persistent
        state: present
    
    - name: Disable default dnsmasq service (conflicts with SDN zone services)
      systemd:
        name: dnsmasq
        enabled: no
        state: stopped
    
    - name: Create SDN configuration directory
      file:
        path: /etc/pve/sdn
        state: directory
        mode: '0755'
    
    - name: Check existing SDN zones
      command: pvesh get /cluster/sdn/zones --output-format json
      register: existing_zones
      changed_when: false
      failed_when: false
    
    - name: Create SDN zones with DHCP enabled
      command: |
        pvesh create /cluster/sdn/zones \
          --zone {{ item.name }} \
          --type {{ item.type }} \
          --dhcp dnsmasq \
          --ipam {{ item.ipam | default('pve') }}
      loop: "{{ sdn_zones | default([]) }}"
      when: sdn_zones is defined and item.name not in (existing_zones.stdout | default('[]', true) | from_json | map(attribute='zone') | list | default([]))
      failed_when: false
    
    - name: Check existing SDN vnets
      command: pvesh get /cluster/sdn/vnets --output-format json
      register: existing_vnets
      changed_when: false
      failed_when: false
    
    - name: Create SDN vnets
      command: |
        pvesh create /cluster/sdn/vnets \
          --vnet {{ item.name }} \
          --zone {{ item.zone }}
      loop: "{{ sdn_vnets | default([]) }}"
      when: sdn_vnets is defined and item.name not in (existing_vnets.stdout | default('[]', true) | from_json | map(attribute='vnet') | list | default([]))
      failed_when: false
    
    - name: Check existing SDN subnets
      command: pvesh get /cluster/sdn/vnets/{{ item.vnet }}/subnets --output-format json
      loop: "{{ sdn_subnets | default([]) }}"
      register: existing_subnets_check
      changed_when: false
      failed_when: false
    
    - name: Create SDN subnets with DHCP enabled
      shell: |
        pvesh create /cluster/sdn/vnets/{{ item.vnet }}/subnets \
          --subnet {{ item.cidr }} \
          --type subnet \
          --gateway {{ item.gateway }} \
          --snat {{ 1 if item.snat else 0 }} \
          {% if item.dhcp_start is defined and item.dhcp_end is defined %}
          --dhcp-range start-address={{ item.dhcp_start }},end-address={{ item.dhcp_end }} \
          {% endif %}
          2>&1
      loop: "{{ sdn_subnets | default([]) }}"
      register: subnet_create
      failed_when: 
        - subnet_create.rc != 0
        - "'already exists' not in subnet_create.stderr"
      changed_when: subnet_create.rc == 0
    
    - name: Ensure dnsmasq configuration directory for sibzone exists
      file:
        path: /etc/dnsmasq.d/sibzone
        state: directory
        mode: '0755'
    
    - name: Configure DNS servers for SDN subnets
      shell: |
        echo "dhcp-option=option:dns-server,8.8.8.8,1.1.1.1" > /etc/dnsmasq.d/sibzone/10-dns.conf
        echo "server=8.8.8.8" >> /etc/dnsmasq.d/sibzone/10-dns.conf
        echo "server=1.1.1.1" >> /etc/dnsmasq.d/sibzone/10-dns.conf
      args:
        creates: /etc/dnsmasq.d/sibzone/10-dns.conf
      register: dns_config
    
    - name: Configure firewall rules for SDN DHCP and DNS
      blockinfile:
        path: /etc/pve/firewall/cluster.fw
        marker: "# {mark} ANSIBLE MANAGED SDN RULES"
        insertafter: "^\\[RULES\\]"
        block: |
          # SDN DHCP and DNS rules - REQUIRED for SDN to work with firewall
          IN DHCPfwd(ACCEPT) -i sibnet -log nolog # DHCP forwarding for SDN
          IN DNS(ACCEPT) -i sibnet -dest 192.168.100.1 -log nolog # DNS queries for SDN
        create: yes
      register: sdn_firewall_rules

    - name: Apply SDN configuration
      command: pvesh set /cluster/sdn
      changed_when: true
      register: sdn_apply
    
    - name: Restart dnsmasq@sibzone service if configuration changed
      systemd:
        name: dnsmasq@sibzone
        state: restarted
      when: dns_config.changed or subnet_create.changed
    
    - name: Ensure dnsmasq@sibzone service is enabled and started
      systemd:
        name: dnsmasq@sibzone
        enabled: yes
        state: started
    
    - name: Wait for SDN to be ready
      pause:
        seconds: 2
      when: sdn_apply.changed
    
    - name: Configure dnsmasq for SDN DHCP
      template:
        src: ../../templates/dnsmasq-sdn.conf.j2
        dest: /etc/dnsmasq.d/sdn.conf
        mode: '0644'
      notify: restart dnsmasq
      when: sdn_subnets is defined and (sdn_subnets | length > 0)
    
    - name: Configure NAT rules for SDN
      iptables:
        table: nat
        chain: POSTROUTING
        source: "{{ item.cidr }}"
        out_interface: "{{ proxmox_bridge }}"
        jump: MASQUERADE
      loop: "{{ sdn_subnets | default([]) }}"
      when: item.snat | default(true)
    
    - name: Check if iptables rules need saving
      command: iptables-save
      register: current_iptables
      changed_when: false
      check_mode: no
    
    - name: Save iptables rules
      command: netfilter-persistent save
      when: current_iptables.stdout is search('MASQUERADE')
      changed_when: true
    
  handlers:
    - name: restart dnsmasq
      systemd:
        name: dnsmasq
        state: restarted
      failed_when: false


